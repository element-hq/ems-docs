<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js element">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Element Enterprise Installer Documentation - 0.6.1</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="src/book-assets/element-theme.css">
        <link rel="stylesheet" href="src/book-assets/font.css">
        <link rel="stylesheet" href="src/book-assets/logo.css">
        <link rel="stylesheet" href="src/book-assets/style.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "element";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('element')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="install-poc.html"><strong aria-hidden="true">1.</strong> How to Install a POC Environment</a></li><li class="chapter-item expanded "><a href="install-prod.html"><strong aria-hidden="true">2.</strong> How to Install a Production Environment</a></li><li class="chapter-item expanded "><a href="permalinks.html"><strong aria-hidden="true">3.</strong> Setting up Permalinks</a></li><li class="chapter-item expanded "><a href="jitsi.html"><strong aria-hidden="true">4.</strong> Setting up Jitsi</a></li><li class="chapter-item expanded "><a href="saml.html"><strong aria-hidden="true">5.</strong> Setting up SSO/SAML</a></li><li class="chapter-item expanded "><a href="groupsync.html"><strong aria-hidden="true">6.</strong> Setting up Group Sync</a></li><li class="chapter-item expanded "><a href="dimension.html"><strong aria-hidden="true">7.</strong> Setting Up the Integration Manager</a></li><li class="chapter-item expanded "><a href="hookshot.html"><strong aria-hidden="true">8.</strong> Setting up GitLab, GitHub, and JIRA Integrations</a></li><li class="chapter-item expanded affix "><a href="SUMMARY.html">Last Updated: April 4, 2022 at 8:30pm London Time</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="element">Element (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        <img alt="Element logo" class="header-logo" src="">
                    </div>

                    <h1 class="menu-title">Element Enterprise Installer Documentation - 0.6.1</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Welcome to the Element Enterprise Installer Documentation! Element Enterprise
Installer enables you to install Element Enterprise for two purposes:</p>
<ul>
<li>Proof of concept on a single node. For this, we use microk8s on Ubuntu or Enterprise Linux.</li>
<li>Production on multiple nodes. For this, we will install into an existing
kubernetes environment.</li>
</ul>
<p>The Element Enterprise Installer supports the following features:</p>
<ul>
<li>Synapse Homeserver - A synapse homeserver configured to Element's best
practices will be installed.</li>
<li>Element Web - An instance of Element Web will be configured to Element's
best practices and immediately available post installation.</li>
<li>SSO / SAML - The installer is able to configure using your LDAP/AD based
infrastructure over SSO/SAML technologies for login.</li>
<li>Group Sync - The installer is able to configure group sync v1, which enables
the application of ACLs from your LDAP/AD architecture to Spaces and Rooms in
the Element ecosystem. Please note that the initial version we are providing
only supports a single node, non-federated configuration.</li>
<li>Dimension Integration Manager - The installer is able to configure the
dimension integration manager, which allows you to serve integrations
on-premise.</li>
<li>Gitlab, Github, and Jira Integrations - The installer is able to configure
hookshot, which provides integrations with Gitlab, Github, and Jira.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="element-enterprise-installer-how-to-install-a-poc-environment"><a class="header" href="#element-enterprise-installer-how-to-install-a-poc-environment">Element Enterprise Installer: How to Install a POC Environment</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Our Element Enterprise PoC Installer can handle the installation of Element
Proof
of Concept (POC) environments. Our standard POC environment is a single node
server with microk8s running that we deploy our Element Enterprise Operator
to, resulting in a fully functioning Synapse server with Element Web that
can be used to conduct a POC. On-premise production deployments use the
same installer and operator, but are intended to be deployed into a full
kubernetes environment.</p>
<p>POC installations are not intended to be run for production purposes. You
should plan on having a different installation for your production
environment. The settings that you use with the installer will carry over
for your production install, but your rooms and spaces will not.</p>
<p>To get started with a POC installation, there are several things that need
to be considered and this guide will work through them:</p>
<ul>
<li><a href="install-poc.html#hostnamesdns">Hostnames/DNS</a></li>
<li><a href="install-poc.html#machine-size">Machine Size</a></li>
<li><a href="install-poc.html#operating-system">Operating System</a></li>
<li><a href="install-poc.html#users">Users</a></li>
<li><a href="install-poc.html#network-specifics">Network Specifics</a></li>
<li><a href="install-poc.html#postgresql-database">Postgresql Database</a></li>
<li><a href="install-poc.html#turn-server">TURN Server</a></li>
<li><a href="install-poc.html#ssl-certificates">SSL Certificates</a></li>
<li><a href="install-poc.html#extra-configuration-items">Extra configuration items</a></li>
</ul>
<p>Once these areas have been covered, you’ll be able to install a POC
environment!</p>
<h2 id="hostnamesdns"><a class="header" href="#hostnamesdns">Hostnames/DNS</a></h2>
<p>You will need hostnames for the following pieces of infrastructure:</p>
<ul>
<li>Element Server</li>
<li>Synapse Server</li>
<li>Dimension Server</li>
<li>Hookshot Server</li>
</ul>
<p>These hostnames must resolve to the appropriate IP addresses. If you have a
proper DNS server with records for these hostnames in place, then you will
be good to go.</p>
<p><code>/etc/hosts</code> may be used as an alternative to proper DNS in a POC scenario
only. In this case, you will need entries similar to:</p>
<pre><code class="language-plaintext">192.168.122.39 element.local element
192.168.122.39 synapse.local synapse
192.168.122.39 dimension.local dimension
192.168.122.39 hookshot.local hookshot
192.168.122.39 local
</code></pre>
<h2 id="machine-size"><a class="header" href="#machine-size">Machine Size</a></h2>
<p>For running a proof of concept with our installer, we support only the x86_64
architecture and recommend the following minimums:</p>
<ul>
<li>No federation: 4 vCPUs/CPUS and 16GB RAM</li>
<li>Federation: 8 vCPUs/CPUS and 32GB RAM</li>
</ul>
<h2 id="operating-system"><a class="header" href="#operating-system">Operating System</a></h2>
<p>To get started, we have tested on Ubuntu 20.04 and Rocky Linux 8.5 (EL 8.5)
and suggest that you start
there as well. For x86_64, you can grab an Ubuntu iso here:</p>
<p><a href="https://releases.ubuntu.com/20.04.3/ubuntu-20.04.3-live-server-amd64.iso">https://releases.ubuntu.com/20.04.3/ubuntu-20.04.3-live-server-amd64.iso</a></p>
<p>or a Rocky ISO here:</p>
<p><a href="https://download.rockylinux.org/pub/rocky/8/isos/x86_64/Rocky-8.5-x86_64-dvd1.iso">https://download.rockylinux.org/pub/rocky/8/isos/x86_64/Rocky-8.5-x86_64-dvd1.iso</a></p>
<p>Note that future references in this document to <code>EL</code> reference Enterprise
Linux.</p>
<h3 id="ubuntu-specific-directions"><a class="header" href="#ubuntu-specific-directions">Ubuntu Specific Directions</a></h3>
<p>Make sure to select docker as a package option. Do set up ssh.</p>
<p>Once you log in, please run:</p>
<pre><code class="language-bash">sudo apt-get update
sudo apt-get upgrade
</code></pre>
<h3 id="el-specific-directions"><a class="header" href="#el-specific-directions">EL Specific directions</a></h3>
<p>Make sure to select &quot;Container Management&quot; in the &quot;Additional Software&quot;
section.</p>
<p>Once you log in, please run:</p>
<pre><code class="language-bash">sudo yum update -y
sudo yum install podman-docker python39-pip -y
sudo yum install
https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm -y
sudo alternatives --set python3 /usr/bin/python3.9
</code></pre>
<p>Add the following lines to <code>/etc/security/limits.conf</code>:</p>
<pre><code class="language-bash">*              soft    nofile  4096
*              hard    nofile  10240
</code></pre>
<h3 id="further-pre-requisites"><a class="header" href="#further-pre-requisites">Further Pre-requisites</a></h3>
<p>You should have the installer unpacked in a directory on your server. We
will refer to this as the installer directory. Both the <code>parameters.yml</code>
and <code>secrets.yml</code> file live in this directory.</p>
<p>Please run the following commands to create the <code>/mnt/data</code> directory and
install the <code>python3-signedjson</code> and <code>pwgen</code> packages which will be used
during the
configuration of the installer.</p>
<p>The <code>/mnt/data</code> directory should have at least 50 GB of space.</p>
<pre><code class="language-bash">sudo mkdir /mnt/data
</code></pre>
<p>Ubuntu:</p>
<pre><code class="language-bash">sudo apt-get install python3-signedjson pwgen -y
</code></pre>
<p>EL:</p>
<pre><code class="language-bash">sudo yum install make gcc python39-devel pwgen -y
</code></pre>
<p>EL: (as a normal user)</p>
<pre><code class="language-bash">pip3 install signedjson --user
</code></pre>
<h3 id="network-specifics"><a class="header" href="#network-specifics">Network Specifics</a></h3>
<p>Element Enterprise On-Premise needs to bind and serve content over:</p>
<ul>
<li>Port 80 TCP</li>
<li>Port 443 TCP</li>
</ul>
<p>In a default Ubuntu installation, these ports are allowed through the
firewall. You will need to ensure that these ports are passed through your
firewall.</p>
<p>For EL, you need to disable the firewall with these command:</p>
<pre><code class="language-bash">sudo systemctl stop firewalld
sudo systemctl disable firewalld
</code></pre>
<p>Further, you need to make sure that your host is able to access the following hosts on the internet:</p>
<ul>
<li>api.snapcraft.io</li>
<li>*.snapcraftcontent.com</li>
<li>gitlab.matrix.org</li>
<li>pypi.org</li>
<li>docker.io</li>
<li>*.docker.com</li>
<li>get.helm.sh</li>
</ul>
<p>Further, you will also need to make sure that your host can access your distributions' package repositories. As these hostnames can vary, it is beyond the scope of this documentation to enumerate them.</p>
<h3 id="users"><a class="header" href="#users">Users</a></h3>
<p>The installer requires that you run it as a non-root user who has sudo
permissions. Please make sure that you have a user who can use <code>sudo</code>. If
you wanted to make a user called <code>element-demo</code> that can use <code>sudo</code>, the
following commands (run as root) would
achieve that:</p>
<p>On Ubuntu:</p>
<pre><code class="language-bash">useradd element-demo
gpasswd -a element-demo sudo
</code></pre>
<p>On EL:</p>
<pre><code class="language-bash">useradd element-demo
gpasswd -a element-demo wheel
</code></pre>
<h3 id="unpacking-the-installer"><a class="header" href="#unpacking-the-installer">Unpacking the Installer</a></h3>
<p>Please make sure that you unpack <code>element-enterprise-installer</code> onto your
POC system. The directory that it unpacks into will be referenced in this
document as the installer directory.</p>
<h2 id="postgresql-database"><a class="header" href="#postgresql-database">Postgresql Database</a></h2>
<p>The installation requires that you have a postgresql
database with a locale of C and UTF8 encoding set up. See
<a href="https://github.com/matrix-org/synapse/blob/develop/docs/postgres.md#set-up-database">https://github.com/matrix-org/synapse/blob/develop/docs/postgres.md#set-up-database</a>
for further details.</p>
<p>If you have this already, please make note of the database name, user,
and password as you will need these to begin the installation.</p>
<p>If you do not already have a database, then the PoC installer will set up
PostgreSQL on your behalf.</p>
<h2 id="turn-server"><a class="header" href="#turn-server">TURN Server</a></h2>
<p>For installations in which you desire to use video conferencing functionality,
you will need to have a TURN server installed and available for Element to use.</p>
<p>If you do not have an existing TURN server, we recommend installing
<code>coturn</code>. Instructions on how to do that are available here:
<a href="https://github.com/matrix-org/synapse/blob/master/docs/turn-howto.md">https://github.com/matrix-org/synapse/blob/master/docs/turn-howto.md</a>
(Note: On EL, you can do <code>yum install coturn -y</code>.)</p>
<h2 id="ssl-certificates"><a class="header" href="#ssl-certificates">SSL Certificates</a></h2>
<p>For SSL Certificates, you have three options:</p>
<ul>
<li>Signed certificates from an internet recognized authority.</li>
<li>LetsEncrypt</li>
<li>Self-signed certificates</li>
</ul>
<p>In the case of Signed certificates or LetsEncrypt, your hostnames must be
accessible on the internet.</p>
<p>In the case of self-signed certificates, these are acceptable for a PoC
environment, but will not be supported in a production environment as the
security risk would be too high. Configuring mobile clients and federation
will not be possible with self-signed certificates.</p>
<p>You will need to configure certificates for the following names:</p>
<ul>
<li>fqdn.tld</li>
<li>element.fqdn.tld</li>
<li>synapse.fqdn.tld</li>
<li>dimension.fqdn.tld</li>
<li>hookshot.fqdn.tld</li>
</ul>
<p>Using our example hosts, this would mean that we need certificates for:</p>
<ul>
<li>local</li>
<li>element.local</li>
<li>synapse.local</li>
<li>dimension.local</li>
<li>hookshot.local</li>
</ul>
<h3 id="certificates-without-letsencrypt"><a class="header" href="#certificates-without-letsencrypt">Certificates without LetsEncrypt</a></h3>
<p>If you have certificates for all of the aforementioned host names,
then you can simply place the <code>.crt</code> and <code>.key</code> files in the certs directory
under the installer directory. Certificates in the certs directory must take
the form of <code>fqdn.cert</code> and <code>fqdn.key</code>.</p>
<h3 id="self-signed-certificates-with-mkcert"><a class="header" href="#self-signed-certificates-with-mkcert">Self-signed certificates with mkcert</a></h3>
<p>The following instructions will enable you to use a tool called mkcert to
generate self-signed certificates. Element nor Canonical ship this tool and
so these directions are provided as one example of how to get self-signed
certificates.</p>
<p>Ubuntu:</p>
<pre><code class="language-bash">sudo apt-get install wget libnss3-tools
</code></pre>
<p>EL:</p>
<pre><code class="language-bash">sudo yum install wget nss-tools -y
</code></pre>
<p>Both EL and Ubuntu:</p>
<pre><code class="language-bash">wget
https://github.com/FiloSottile/mkcert/releases/download/v1.4.3/mkcert-v1.4.3-linux-amd64
sudo mv mkcert-v1.4.3-linux-amd64 /usr/bin/mkcert
sudo chmod +x /usr/bin/mkcert
</code></pre>
<p>Once you have mkcert executable, you can run:</p>
<pre><code class="language-bash">mkcert -install
The local CA is now installed in the system trust store! ⚡️
</code></pre>
<p>Now, you can verify the CA Root by doing:</p>
<pre><code class="language-bash">mkcert -CAROOT
/home/element-demo/.local/share/mkcert
</code></pre>
<p>Your output may not be exactly the same, but it should be similar. Once we’ve
done this, we need to generate self-signed certificates for our hostnames. The
following is an example of how to do it for <code>element.local</code>. You will need
to do this for all of the aforementioned hostnames, including the <code>fqdn.tld</code>.</p>
<p>The run for the element fqdn looks like this:</p>
<pre><code class="language-bash">mkcert element.local element 192.168.122.39 127.0.0.1

Created a new certificate valid for the following names
- &quot;element.local&quot;
- &quot;element&quot;
- &quot;192.168.122.39&quot;
- &quot;127.0.0.1&quot;

The certificate is at &quot;./element.local+3.pem&quot; and the key at
&quot;./element.local+3-key.pem&quot; ✅

It will expire on 1 May 2024
</code></pre>
<p>Once you have self-signed certificates, you need to copy them into the certs
directory under the installer directory. Certificates in the certs directory
must take the form of <code>fqdn.crt</code> and <code>fqdn.key</code>.</p>
<p>Using our above example, these are the commands we would need to run from
the installer directory: (We ran <code>mkcert</code> in that directory as well.)</p>
<pre><code class="language-bash">cp element.local+3.pem certs/element.local.crt
cp element.local+3-key.pem certs/element.local.key
cp synapse.local+3.pem certs/synapse.local.crt
cp synapse.local+3-key.pem certs/synapse.local.key
cp dimension.local+3.pem certs/dimension.local.crt
cp dimension.local+3-key.pem certs/dimension.local.key
cp hookshot.local+3.pem certs/hookshot.local.crt
cp hookshot.local+3-key.pem certs/hookshot.local.key
cp local+2.pem certs/local.crt
cp local+2-key.pem certs/local.key
</code></pre>
<h3 id="certificates-with-letsencrypt"><a class="header" href="#certificates-with-letsencrypt">Certificates with LetsEncrypt</a></h3>
<p>Our installer also supports using LetsEncrypt to build certificates for your
host names and automatically install them into your environment. If your
hosts are internet accessible, this is the easiest method and only requires
an admin email address to provide to LetsEncrypt.</p>
<h2 id="parametersyml"><a class="header" href="#parametersyml">parameters.yml</a></h2>
<p>Now it is time to set <code>parameters.yml</code>. A sample has been provided and to
get started, it is easiest to do:</p>
<pre><code class="language-bash">cp parameters.yml.sample parameters.yml
</code></pre>
<p>Using the example hostnames of
<code>element.local</code> and <code>synapse.local</code> (not resolvable on the internet), we
would set the following parameters first in <code>parameters.yml</code>:</p>
<pre><code class="language-bash">domain_name: local
element_fqdn: element.local
synapse_fqdn: synapse.local
</code></pre>
<p>Next, we need to set the variables related to Postgres. If you do not have
an existing Postgres server, do not make any changes. If you have an
existing Postgres server, set the following:</p>
<pre><code class="language-bash">postgres_create_in_cluster: false
postgres_fqdn: `Postgres Server`
postgres_user: `Postgres User`
postgres_db: `Postgres Database for Element`
</code></pre>
<p>The next item in the configuration is the microk8s DNS resolvers. By default,
the installer will use Google's publicly available DNS servers. If you have
defined your hosts on a
non-publicly available DNS server, then you should use your DNS servers
instead of the publicly available Google DNS servers. Let's assume that
your local dns servers are 192.168.122.253 and 192.168.122.252. To use those
servers, you would need to add this line:</p>
<pre><code class="language-bash">microk8s_dns_resolvers: &quot;192.168.122.253,192.168.122.252&quot;
</code></pre>
<p>The next section pertains to certmanager. If you are using your own
certificates, please leave these items both blank, as such:</p>
<pre><code class="language-bash">certmanager_issuer:
certmanager_admin_email:
</code></pre>
<p>If you have chosen to use letsencrypt, please specify “letsencrypt” for
the certmanager_issue and an actual email address for who should manage the
certificates for certmanager_admin_email:</p>
<pre><code class="language-bash">certmanager_issuer: 'letsencrypt'
certmanager_admin_email: 'admin@mydomain.com'
</code></pre>
<h2 id="secretsyml"><a class="header" href="#secretsyml">secrets.yml</a></h2>
<p>Now we move on to configuring <code>secrets.yml</code>. You will need the following
items here:</p>
<ul>
<li>A Macaroon key</li>
<li>Your postgres password for the user specified in parameters.yml</li>
<li>A Registration Shared Secret</li>
<li>A signing Key</li>
<li>A Registry username and token, which will have been provided to you
by Element.</li>
</ul>
<p>To build a <code>secrets.yml</code> with the macaroon key, the registration shared secret,
the generic shared secret, and the signing key already filled in, please run:</p>
<pre><code class="language-bash">sh build_secrets.sh
</code></pre>
<p>If you are using your own Postgres server, you will need to uncomment and
fill in the <code>postgres_password</code>. If you are letting the installer install
Postgres for you, then you will need to set a random password. You can
generate a random password with:</p>
<pre><code class="language-bash">pwgen 32 1
</code></pre>
<p>and then insert that value in the <code>postgres_password</code> field, making sure
that you uncomment the line.</p>
<p>Do not forget to also set the values for <code>registry_username</code> and
<code>registry_token</code>, which will both be provided by Element.</p>
<p>If you have a paid docker hub account, you can specify your username
and password to avoid being throttled in the <code>dockerhub_username</code> and
<code>dockerhub_token</code> fields. This is optional.</p>
<h2 id="extra-configuration-items"><a class="header" href="#extra-configuration-items">Extra Configuration Items</a></h2>
<p>It is possible to configure anything in Synapse's
<a href="https://github.com/matrix-org/synapse/blob/develop/docs/sample_config.yaml">homeserver.yaml</a>
or Element’s
<a href="https://github.com/vector-im/element-web/blob/develop/docs/config.md">config.json</a>.</p>
<p>To do so, you need to create json or yaml files in an <code>extra-config</code>
directory under the installer directory. These files will be merged to the
target configuration file.</p>
<p>Samples are available in <code>config-sample</code> under the installer directory.</p>
<p>To configure synapse:</p>
<ul>
<li>Create a directory <code>extra-config/synapse</code> at the root of the installer
directory : <code>mkdir -p extra-config/synapse</code></li>
<li>Copy the configurations extensions you want to setup from
<code>config-sample/synapse</code> to <code>extra-config/synapse</code>.</li>
<li>Edit the values in the file accordingly to your configuration</li>
</ul>
<p>To configure element:</p>
<ul>
<li>Create a directory <code>extra-config/element</code> at the root of the installer
directory : <code>mkdir -p extra-config/element</code></li>
<li>Copy the configurations extensions you want to setup from
<code>config-sample/element</code> to <code>extra-config/element</code>.</li>
<li>Edit the values in the file accordingly to your configuration</li>
</ul>
<p>For specifics on configuring permalinks for Element, please see <a href="./permalinks.html">Configuring
Permalinks</a>.</p>
<p>For specifics on setting up SSO/SAML, please see <a href="./saml.html">Setting up
SSO/SAML</a>.</p>
<p>For specifics on setting up Group Sync, please see <a href="./groupsync.html">Setting up Group
Sync</a>.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>Let’s review! Have you considered:</p>
<ul>
<li><a href="install-poc.html#hostnamesdns">Hostnames/DNS</a></li>
<li><a href="install-poc.html#operating-system">Operating System</a></li>
<li><a href="install-poc.html#users">Users</a></li>
<li><a href="install-poc.html#network-specifics">Network Specifics</a></li>
<li><a href="install-poc.html#postgresql-database">Postgresql Database</a></li>
<li><a href="install-poc.html#turn-server">TURN Server</a></li>
<li><a href="install-poc.html#ssl-certificates">SSL Certificates</a></li>
<li><a href="install-poc.html#extra-configuration-items">Extra configuration items</a></li>
</ul>
<p>Once you have the above sections taken care of and your <code>parameters.yml</code>
and <code>secrets.yml</code> files are in order, you are ready to begin the actual
installation.</p>
<p>From the installer directory, run:</p>
<pre><code class="language-bash">bash install.sh
</code></pre>
<p>The first run should go for a little while and then exit, instructing you
to log out and back in.</p>
<p>Please log out and back in and re-run the installer from the installer
directory again:</p>
<pre><code class="language-bash">bash install.sh
</code></pre>
<p>Once this has finished, you can run:</p>
<pre><code class="language-bash">kubectl get pods -n element-onprem
</code></pre>
<p>And you should get similar output to:</p>
<pre><code class="language-bash">NAME                                        READY   STATUS    RESTARTS   AGE
app-element-web-c5bd87777-rqr6s             1/1     Running   1          29m
server-well-known-8c6bd8447-wddtm           1/1     Running   1          29m
postgres-0                                  1/1     Running   1          40m
instance-synapse-main-0                     1/1     Running   2          29m
instance-synapse-haproxy-5b4b55fc9c-hnlmp   1/1     Running   0          20m
</code></pre>
<p>At this time, you should also be able to browse to: <code>https://fqdn</code> and create
a test account with Element on your new homeserver. Using our example values,
I am able to go to <code>https://element.local/</code> and register an account, sign
in and begin testing the proof of concept!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="element-enterprise-installer-how-to-install-a-production-environment"><a class="header" href="#element-enterprise-installer-how-to-install-a-production-environment">Element Enterprise Installer: How to Install a Production Environment</a></h1>
<p>Our Element Enterprise Production Installer can handle the installation of
Element Enterprise into your production k8s environment.</p>
<p>To get started with a production installation, there are several things that
need to be considered and this guide will work through them:</p>
<ul>
<li><a href="install-prod.html#hostnamesdns">Hostnames/DNS</a></li>
<li><a href="install-prod.html#resource-requirements">Resource Requirements</a></li>
<li><a href="install-prod.html#k8s-environments">k8s Environments</a></li>
<li><a href="install-prod.html#postgresql-database">Postgresql Database</a></li>
<li><a href="install-prod.html#turn-server">TURN Server</a></li>
<li><a href="install-prod.html#ssl-certificates">SSL Certificates</a></li>
<li><a href="install-prod.html#extra-configuration-items">Extra configuation items</a></li>
</ul>
<p>Once these areas have been covered, you'll be able to install a production
environment!</p>
<h2 id="hostnamesdns-1"><a class="header" href="#hostnamesdns-1">Hostnames/DNS</a></h2>
<p>You will need hostnames for the following pieces of infrastructure:</p>
<ul>
<li>Element Server</li>
<li>Synapse Server</li>
<li>Dimension Server</li>
<li>Hookshot Server</li>
</ul>
<p>These hostnames must resolve to the appropriate IP addresses. You must have
a proper DNS server to serve these records in a production environment.</p>
<h2 id="resource-requirements"><a class="header" href="#resource-requirements">Resource Requirements</a></h2>
<p>For running running in production, we support only the x86_64
architecture and recommend the following minimums:</p>
<ul>
<li>No federation: 4 vCPUs/CPUS and 16GB RAM</li>
<li>Federation: 8 vCPUs/CPUS and 32GB RAM</li>
</ul>
<h3 id="unpacking-the-installer-1"><a class="header" href="#unpacking-the-installer-1">Unpacking the Installer</a></h3>
<p>Please make sure that you unpack <code>element-enterprise-installer</code> onto a system
that has access to your k8s environment. The directory that it unpacks into
will be referenced in this document as the installer directory.</p>
<h2 id="k8s-environments"><a class="header" href="#k8s-environments">k8s Environments</a></h2>
<p>Element Enterprise Installer allows you to either deploy directly into a kubernetes environment or to render a set of manifests for a future deployment in a kubernetes environment.</p>
<p>To configure your kubernetes environment for a direct deployment, you need to :</p>
<ul>
<li>Configure a kubectl context able to connect to your kubernetes instance</li>
<li>Copy <code>k8s.yml.sample</code> to <code>k8s.yml</code>. Edit <code>k8s.yml</code> with the following
values :</li>
<li><code>provider_storage_class_name</code>: The <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/">storage
class</a>
to use when creating PVCs.</li>
<li><code>ingress_annotations</code>: The annotations to add to the ingresses created
by the operator.</li>
<li><code>tls_managed_externally</code>: Should be true if you don't expect the operator
to manage the certificates of your kubernetes deployment. In this case, you
will be able to skip the *<em>Certificates</em>- chapter of the <code>CONFIGURE.md</code> file.</li>
<li><code>operator_namespace</code>: The namespace to create to deploy the operator.</li>
<li><code>element_namespace</code>: The namespace to create to deploy the element
resources.</li>
<li><code>k8s_auth_context</code>: The value of the context used in kubectl.
If you want to use
<a href="https://cert-manager.io/docs/configuration/acme/">cert-manager</a> for your
tls certificates, it needs to be already installed in the targeted k8s cluster.</li>
</ul>
<p>If you do not want to deploy directly to kubernetes, but wish to render manifests instead, set all of the above mentioned variables except for <code>k8s_auth_context</code> and define a value for the parameter <code>out_dir</code>, which specifies where to write the kubernetes manifests. Further, when you go to run the installer, you need to invoke it as such:</p>
<pre><code class="language-bash">bash install.sh --target render
</code></pre>
<p>Using the above syntax, you will have a set of manifests written out to <code>out_dir</code> that you can then deploy into your kubernetes environment.</p>
<h2 id="postgresql-database-1"><a class="header" href="#postgresql-database-1">Postgresql Database</a></h2>
<p>The installation requires that you have a postgresql
database with a locale of C and UTF8 encoding set up. See
<a href="https://github.com/matrix-org/synapse/blob/develop/docs/postgres.md#set-up-database">https://github.com/matrix-org/synapse/blob/develop/docs/postgres.md#set-up-database</a>
for further details.</p>
<p>Please make note of the database hostname, database name, user,
and password as you will need these to begin the installation.</p>
<h2 id="turn-server-1"><a class="header" href="#turn-server-1">TURN Server</a></h2>
<p>For installations in which you desire to use video conferencing functionality,
you will need to have a TURN server installed and available for Element to use.</p>
<p>If you do not have an existing TURN server, we recommend installing
<code>coturn</code> outside of your k8s environment. <code>coturn</code> must open a lot of ports
to work and this can be problematic for k8s environments. Instructions on
how to do that are available here:
<a href="https://github.com/matrix-org/synapse/blob/master/docs/turn-howto.md">https://github.com/matrix-org/synapse/blob/master/docs/turn-howto.md</a></p>
<h2 id="ssl-certificates-1"><a class="header" href="#ssl-certificates-1">SSL Certificates</a></h2>
<p>For SSL Certificates, you have three options:</p>
<ul>
<li>Signed certificates from an internet recognized authority.</li>
<li>LetsEncrypt</li>
<li>Signed certificates from an internal to your company authority.</li>
</ul>
<p>In the case of Internet Recognized Signed certificates or LetsEncrypt,
your hostnames must be
accessible on the internet.</p>
<h3 id="certificates-without-letsencrypt-1"><a class="header" href="#certificates-without-letsencrypt-1">Certificates without LetsEncrypt</a></h3>
<p>If you have certificates for all of the aforementioned host names,
then you can simply place the <code>.crt</code> and <code>.key</code> files in the certs directory
under the installer directory. Certificates in the certs directory must take
the form of <code>fqdn.cert</code> and <code>fqdn.key</code>.</p>
<h3 id="certificates-with-letsencrypt-1"><a class="header" href="#certificates-with-letsencrypt-1">Certificates with LetsEncrypt</a></h3>
<p>Our installer also supports using LetsEncrypt to build certificates for your
host names and automatically install them into your environment. If your
hosts are internet accessible, this is the easiest method and only requires
an admin email address to provide to LetsEncrypt.</p>
<h2 id="parametersyml-1"><a class="header" href="#parametersyml-1">parameters.yml</a></h2>
<p>Now it is time to set <code>parameters.yml</code>. A sample has been provided and to
get started, it is easiest to do:</p>
<pre><code class="language-bash">cp parameters.yml.sample parameters.yml
</code></pre>
<p>Using the example hostnames of
<code>element.local</code> and <code>synapse.local</code> (not resolvable on the internet), we
would set the following parameters first in <code>parameters.yml</code>:</p>
<pre><code class="language-bash">domain_name: local
element_fqdn: element.local
synapse_fqdn: synapse.local
</code></pre>
<p>Next, we need to set the variables related to Postgres. For your Postgres
server, please set the following:</p>
<pre><code class="language-bash">postgres_fqdn: `Postgres Server`
postgres_user: `Postgres User`
postgres_db: `Postgres Database for Element`
</code></pre>
<p>The next item in the configuration is the microk8s DNS resolvers. By default,
the installer will use Google's publicly available DNS servers. If you have
defined your hosts on a
non-publicly available DNS server, then you should use your DNS servers
instead of the publicly available Google DNS servers. Let's assume that
your local dns servers are 192.168.122.253 and 192.168.122.252. To use those
servers, you would need to add this line:</p>
<pre><code class="language-bash">microk8s_dns_resolvers: &quot;192.168.122.253,192.168.122.252&quot;
</code></pre>
<p>The next section pertains to certmanager. If you are not using LetsEncrypt,
please leave these items both blank, as such:</p>
<pre><code class="language-bash">certmanager_issuer:
certmanager_admin_email:
</code></pre>
<p>If you have chosen to use LetsEncrypt, please specify “letsencrypt” for
the certmanager_issue and an actual email address for who should manage the
certificates for certmanager_admin_email:</p>
<pre><code class="language-bash">certmanager_issuer: 'letsencrypt'
certmanager_admin_email: 'admin@mydomain.com'
</code></pre>
<h2 id="secretsyml-1"><a class="header" href="#secretsyml-1">secrets.yml</a></h2>
<p>Now we move on to configuring <code>secrets.yml</code>. You will need the following
items here:</p>
<ul>
<li>A Macaroon key</li>
<li>Your postgres password for the user specified in parameters.yml</li>
<li>A Registration Shared Secret</li>
<li>A signing Key</li>
<li>A Registry username and token, which will have been provided to you
by Element.</li>
</ul>
<p>To build a <code>secrets.yml</code> with the macaroon key, the registration shared secret,
the generic shared secret, and the signing key already filled in, please run:</p>
<pre><code class="language-bash">sh build_secrets.sh
</code></pre>
<p>You will need to uncomment and set your <code>postgres_password</code> field to the
proper password for your database.</p>
<p>Do not forget to also set the values for <code>registry_username</code> and
<code>registry_token</code>, which will both be provided by Element.</p>
<p>If you have a paid docker hub account, you can specify your username
and password to avoid being throttled in the <code>dockerhub_username</code> and
<code>dockerhub_token</code> fields. This is optional.</p>
<h2 id="extra-configuration-items-1"><a class="header" href="#extra-configuration-items-1">Extra Configuration Items</a></h2>
<p>It is possible to configure anything in Synapse's
<a href="https://github.com/matrix-org/synapse/blob/develop/docs/sample_config.yaml">homeserver.yaml</a>
or Element’s
<a href="https://github.com/vector-im/element-web/blob/develop/docs/config.md">config.json</a>.</p>
<p>To do so, you need to create json or yaml files in an <code>extra-config</code>
directory under the installer directory. These files will be merged to the
target configuration file.</p>
<p>Samples are available in <code>config-sample</code> under the installer directory.</p>
<p>To configure synapse:</p>
<ul>
<li>Create a directory <code>extra-config/synapse</code> at the root of the installer
directory : <code>mkdir -p extra-config/synapse</code></li>
<li>Copy the configurations extensions you want to setup from
<code>config-sample/synapse</code> to <code>extra-config/synapse</code>.</li>
<li>Edit the values in the file accordingly to your configuration</li>
</ul>
<p>To configure element:</p>
<ul>
<li>Create a directory <code>extra-config/element</code> at the root of the installer
directory : <code>mkdir -p extra-config/element</code></li>
<li>Copy the configurations extensions you want to setup from
<code>config-sample/element</code> to <code>extra-config/element</code>.</li>
<li>Edit the values in the file accordingly to your configuration</li>
</ul>
<p>For specifics on configuring permalinks for Element, please see <a href="./permalinks.html">Configuring
Permalinks</a>.</p>
<p>For specifics on setting up SSO/SAML, please see <a href="./saml.html">Setting up
SSO/SAML</a>.</p>
<p>For specifics on setting up Group Sync, please see <a href="./groupsync.html">Setting up Group
Sync</a>.</p>
<h2 id="installation-1"><a class="header" href="#installation-1">Installation</a></h2>
<p>Let’s review! Have you considered:</p>
<ul>
<li><a href="install-poc.html#hostnamesdns">Hostnames/DNS</a></li>
<li><a href="install-prod.html#k8s-environments">k8s Environments</a></li>
<li><a href="install-poc.html#postgresql-database">Postgresql Database</a></li>
<li><a href="install-poc.html#turn-server">TURN Server</a></li>
<li><a href="install-poc.html#ssl-certificates">SSL Certificates</a></li>
<li><a href="install-poc.html#extra-configuration-items">Extra configuration items</a></li>
</ul>
<p>Once you have the above sections taken care of and your <code>parameters.yml</code>
and <code>secrets.yml</code> files are in order, you are ready to begin the actual
installation.</p>
<p>From the installer directory, run:</p>
<pre><code class="language-bash">bash install.sh
</code></pre>
<p>The first run should go for a little while and then exit, instructing you
to log out and back in.</p>
<p>Please log out and back in and re-run the installer from the installer
directory again:</p>
<pre><code class="language-bash">bash install.sh
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-permalinks"><a class="header" href="#configuring-permalinks">Configuring Permalinks</a></h1>
<h2 id="element-extra-configurations"><a class="header" href="#element-extra-configurations">Element Extra Configurations</a></h2>
<ul>
<li>Copy sample file from <code>config-sample/element/permalinks.json</code> to
<code>extra-config/element</code></li>
<li>Edit the file :</li>
</ul>
<pre><code class="language-lang-none">{
    &quot;permalinkPrefix&quot;: &quot;https://&lt;element fqdn&gt;&quot;
}
</code></pre>
<ul>
<li>Restart the install script</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-jitsi"><a class="header" href="#configuring-jitsi">Configuring Jitsi</a></h1>
<p>By default, our installer will give you an instance of element-web configured to use the <code>meet.element.io</code> Jitsi server. If you would like to specify your own Jitsi server for your element-web instance to use, please follow these directions.</p>
<h2 id="element-extra-configurations-1"><a class="header" href="#element-extra-configurations-1">Element Extra Configurations</a></h2>
<ul>
<li>Create a file called <code>jitsi.json</code> in the <code>extra-config/element</code> directory.</li>
<li>Edit the file :</li>
</ul>
<pre><code class="language-lang-none">{
      &quot;jitsi&quot;: {
            &quot;preferredDomain&quot;: &quot;your.jitsi.example.org&quot;
      }
}
</code></pre>
<p>replacing <code>your.jitsi.example.org</code> with the hostname of your Jitsi server.</p>
<ul>
<li>Restart the install script</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-saml"><a class="header" href="#configuring-saml">Configuring SAML</a></h1>
<h2 id="on-element-enterprise"><a class="header" href="#on-element-enterprise">On Element Enterprise</a></h2>
<ul>
<li>Depending on your provider, copy the sample file in the installer root
directory from <code>config-sample/synapse/</code> to <code>extra-config/synapse</code></li>
<li>Edit the file for the provider you are setting up. You have at least 3
parameters to edit :
<ul>
<li>The IdP metadata url</li>
<li>The name and description of your synapse server, which your provider
would display to inform the users to which app they are logging in</li>
</ul>
</li>
<li>Run the installer to configure SAML provisioning</li>
</ul>
<h2 id="on-the-provider"><a class="header" href="#on-the-provider">On the provider</a></h2>
<p><a href="./saml.html#azure-adfs">Azure ADFS</a></p>
<p><a href="./saml.html#keycloak">Keycloak</a></p>
<p>Other SAML providers can be configured for use with Element Enterprise. Please
contact Element for further information in the event that you are not using
one of the above providers.</p>
<h3 id="azure-adfs"><a class="header" href="#azure-adfs">Azure ADFS</a></h3>
<ul>
<li>With an account with enough rights, go to : <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/StartboardApplicationsMenuBlade/AllApps/menuId/">Enterprise Applications
Portal</a></li>
<li>Click on  <code>New Application</code></li>
<li>Click on <code>Create your own application</code> on the top left corner</li>
<li>Choose a name for it, and select <code>Integrate any other application you don't find in the gallery</code></li>
<li>Click on &quot;Create&quot;</li>
<li>Select <code>Set up single sign on</code></li>
<li>Select <code>SAML</code></li>
<li><code>Edit</code> on <code>Basic SAML Configuration</code></li>
<li>In <code>Identifier</code>, add the following URL : <code>https://&lt;synapse fqdn&gt;/_synapse/client/saml2/metadata.xml</code></li>
<li>Remove the default URL</li>
<li>In <code>Reply URL</code>, add the following URL : <code>https://&lt;synapse fqdn&gt;/_synapse/client/saml2/authn_response</code></li>
<li>Click on <code>Save</code></li>
<li><code>Edit</code> on <code>Attributes &amp; Claims</code></li>
<li>Remove all defaults additional claims</li>
<li>Click on <code>Add new claim</code> to add the following claims. The UID will be used
as the MXID, the value here is mostly a suggestion :
<ul>
<li>Name: <code>uid</code>, Transformation : <code>ExtractMailPrefix</code>, Parameter 1 :
<code>user.userprincipalname</code></li>
<li>Name: <code>email</code>, Source attribute : <code>user.mail</code></li>
<li>Name: <code>displayName</code>, Source attribute : <code>user.displayname</code></li>
</ul>
</li>
<li>Click on <code>Save</code></li>
<li>In <code>Users and Groups</code>, add groups and users which may have access to element</li>
</ul>
<h3 id="keycloak"><a class="header" href="#keycloak">Keycloak</a></h3>
<ul>
<li>In <code>Configure</code> &gt; <code>Clients</code>, add a new client. Enter <code>https://&lt;synapse fqdn&gt;/_synapse/client/saml2/metadata.xml</code> as its Client ID</li>
<li>In <code>Mappers</code>, add the 3 following mappers :
<ul>
<li>Name: <code>uid</code> : User attribute : <code>username</code></li>
<li>Name: <code>email</code>, User attribute : <code>email</code></li>
<li>Name: <code>displayName</code>, Javascript mapper : <code>user.FirstName + &quot; &quot; + user.lastName</code></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-group-sync"><a class="header" href="#configuring-group-sync">Configuring Group Sync</a></h1>
<h2 id="what-is-group-sync"><a class="header" href="#what-is-group-sync">What is Group Sync?</a></h2>
<p>Group Sync allows you to use the ACLs from your identity infrastructure
in order to set up permissions on Spaces and Rooms in the Element
Ecosystem. Please note that the initial version we are providing
only supports a single node, non-federated configuration.</p>
<h2 id="general-settings"><a class="header" href="#general-settings">General settings</a></h2>
<ul>
<li>Copy sample file from <code>config-sample/groupsync/gsync.yml</code> to
<code>extra-config/groupsync</code></li>
<li>Edit the file with the following values :
<ul>
<li><code>ems_bridges_registry_username</code>: <code>ems bridges registry token name</code></li>
<li><code>ems_bridges_registry_password</code>: <code>ems bridges registry token password</code></li>
<li><code>group_power_levels</code> : A list of groups that'll determine people's
Matrix power levels. This affects only the space that the Group belongs
to – doesn't leak up or down. For MSGraph source, groups should be
identified by their ids. On LDAP, they should be identified by their names.</li>
<li><code>provisioner.dn_default_prefix</code>: Display names starting with this
prefix will get corrected according to the names we found for their
users in LDAP. Optional. Useful if you're using an OIDC provider that
doesn't give you users' display names.</li>
<li><code>provisioner.default_rooms</code> : Optional. A list of rooms that'll get
automatically created in in managed space. The ID is required to enable
GPS to track whether they were already created or not. You can change it,
but it'll cause new rooms to be generated.</li>
<li><code>provisioner.whitelisted_users</code> : Optional. A list of userid patterns
that will not get kicked from rooms even if they don't belong to them
according to LDAP. This is useful for things like the auditbot. Patterns
listed here will be wrapped in ^ and $ before matching.</li>
</ul>
</li>
</ul>
<h2 id="configuring-the-source"><a class="header" href="#configuring-the-source">Configuring the source</a></h2>
<h3 id="ldap-servers"><a class="header" href="#ldap-servers">LDAP Servers</a></h3>
<ul>
<li>You should create a ldap account with read access to the OUs containing
the users</li>
<li>This account should use password authentication</li>
<li>To use LDAP source, copy the file  <code>config-sample/groupsync/ldap.yml</code> to
<code>extra-config/groupsync</code> the following variables :
<ul>
<li><code>ldap_check_interval_seconds</code>: The interval check in seconds</li>
<li><code>ldap_uri</code>: The LDAP Uri to connect to the ldap server</li>
<li><code>ldap_base</code>: The LDAP base used to build the space hierarchy. This OU
will become the root space. Every OU below this base will be a child-space.</li>
<li><code>ldap_bind_dn</code>: The user bind dn to use to read the space hierarchy.</li>
<li><code>ldap_bind_password</code>: The user password</li>
<li><code>ldap_attrs_uid</code>: The attribute to use to map to users mxids</li>
<li><code>ldap_attrs_name</code>: The attribute to use to map to spaces names</li>
</ul>
</li>
<li>Restart the install script</li>
</ul>
<h3 id="ms-graph-azure-ad"><a class="header" href="#ms-graph-azure-ad">MS Graph (Azure AD)</a></h3>
<ul>
<li>
<p>You need to create an <code>App registration</code>. You'll need the <code>Tenant ID</code> of
the organization, the <code>Application (client ID)</code> and a secret generated from
<code>Certificates &amp; secrets</code> on the app.</p>
</li>
<li>
<p>For the bridge to be able to operate correctly, navigate to API permissions
and ensure it has access to Group.Read.All, GroupMember.Read.All and
User.Read.All</p>
</li>
<li>
<p>Remember to grant the admin consent for those.</p>
</li>
<li>
<p>To use MSGraph source, copy the file  <code>config-sample/groupsync/msgraph.yml</code>
to <code>extra-config/groupsync</code> the following variables :</p>
<ul>
<li><code>msgraph_tenant_id</code>: This is the &quot;Tenant ID&quot; from your Azure Active
Directory Overview</li>
<li><code>msgraph_client_id</code>: Register your app in &quot;App registrations&quot;. This
will be its &quot;Application (client) ID&quot;</li>
<li><code>msgraph_client_secret</code> : Go to &quot;Certificates &amp; secrets&quot;, and click
on &quot;New client secret&quot;. This will be the &quot;Value&quot; of the created secret
(not the &quot;Secret ID&quot;).</li>
</ul>
</li>
<li>
<p>Restart the install script</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-dimension-integration-manager"><a class="header" href="#configuring-dimension-integration-manager">Configuring Dimension integration manager</a></h1>
<h2 id="on-the-hosting-machine"><a class="header" href="#on-the-hosting-machine">On the hosting machine</a></h2>
<ul>
<li>Copy sample file from <code>config-sample/dimension/dimension.yml</code> to
<code>extra-config/dimension</code></li>
<li>Edit the file with the following values :
<ul>
<li><code>ems_bridges_registry_username</code>: ems bridges registry token name</li>
<li><code>ems_bridges_registry_password</code>: ems bridges registry token password</li>
<li><code>dimension_fqdn</code>: The access address to dimension. It should match
something like <code>dimension.&lt;fqdn.tld&gt;</code></li>
<li><code>admins</code>: List of mxids with admin access to dimension</li>
<li><code>widget_blocklist</code>: CIDRs listed here will be blocked from becoming
widgets.</li>
<li><code>postgres_fqdn</code>: PostgreSQL server fqdn or ip</li>
<li><code>postgres_user</code>: PostgreSQL username</li>
<li><code>postgres_db</code>: PostgreSQL dimension database</li>
<li><code>postgres_password</code>: PostgreSQL dimension password</li>
<li><code>bot_data_size</code>: The size of the space allocated to bot data.</li>
<li><code>bot_data_path</code>: The path on the hosting machine to the space allocated
to bot data</li>
</ul>
</li>
<li>Restart the install script</li>
</ul>
<h2 id="on-element"><a class="header" href="#on-element">On element</a></h2>
<ul>
<li>Copy sample file from <code>config-sample/element/dimension.json</code> to
<code>extra-config/element</code></li>
<li>Edit the file to replace <code>&lt; dimension_fqdn &gt;</code> to your dimension instance
fqdn.</li>
<li>Restart the install script</li>
</ul>
<h2 id="enabling-bigbluebutton"><a class="header" href="#enabling-bigbluebutton">Enabling BigBlueButton</a></h2>
<p>To enable BigBlueButton integration into Element through Dimension, you
should set the following variables.</p>
<ul>
<li><code>bbb_api_base_url</code>: The full base URL of the API of your BigBlueButton
instance</li>
<li><code>bbb_shared_secret</code>:  The &quot;shared secret&quot; of your BigBlueButton
instance. This is used to authenticate to the API above.</li>
<li><code>bbb_widget_name</code>:  The title for BigBlueButton widgets that are generated
by Dimension.</li>
<li><code>bbb_widget_title</code>: The subtitle for BigBlueButton widgets that are
generated by Dimension.</li>
<li><code>bbb_widget_avatar_mxc</code>:  The avatar for BigBlueButton widgets that are
generated by Dimension. Usually this doen't need to be changed, however if
your homeserver is not able to reach t2bot.io then you should specify your
own here.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gitlab-github-and-jira-integrations"><a class="header" href="#gitlab-github-and-jira-integrations">GitLab, GitHub, and JIRA Integrations</a></h1>
<p>In Element Enterprise On-Premise, our GitLab, GitHub, and JIRA integrations
are provided by the hookshot package. This documentation explains how to
configure the installer to install hookshot and then how to interact with
hookshot once installed.</p>
<h2 id="configuring-hookshot-with-the-installer"><a class="header" href="#configuring-hookshot-with-the-installer">Configuring Hookshot with the Installer</a></h2>
<ul>
<li>Copy sample file from <code>config-sample/hookshot/hookshot.yml</code> to
<code>extra-config/hookshot</code></li>
<li>Edit the file with the following values :
<ul>
<li><code>ems_bridges_registry_username</code> :  ems bridges registry token name</li>
<li><code>ems_bridges_registry_password</code> :  ems bridges registry token password</li>
<li><code>logging_level</code> : The logging level</li>
<li><code>hookshot_fqdn</code> : The adress of hookshot webhook fqdn. It should match
something like <code>hookshot.&lt;fqdn.tld&gt;</code></li>
<li><code>passkey</code> : The name of the local key file. It can be generated using
openssl - <code>openssl genrsa -out key.pem 4096</code></li>
<li><code>provisioning_secret</code> : The provisioning secret used with integration
managers. Necessary for integration with dimension.</li>
<li><code>bot_name</code> : The name of hookshot bot</li>
<li><code>bot_avatar</code> : An <code>mxc://</code> uri to the hookshot bot avatar image.</li>
</ul>
</li>
<li>Restart the install script</li>
</ul>
<h2 id="enabling-github-integration"><a class="header" href="#enabling-github-integration">Enabling GitHub Integration</a></h2>
<h3 id="on-github"><a class="header" href="#on-github">On GitHub</a></h3>
<ul>
<li>This bridge requires a <a href="https://github.com/settings/apps/new">GitHub
App</a>. You will need to create one.</li>
<li>On the callback URL, set the following one : <code>https://&lt;hookshot_fqdn&gt;/oauth</code>
and enable <code>Request user authorization (OAuth) during installation</code></li>
<li>On the webhook URL, set the following one : <code>https://&lt;hookshot_fqdn&gt;/</code></li>
<li>For the webhook secret, you can generate one using <code>pwgen 32 1</code>
to generate one for example. Keep it somewhere safe, you'll need to to
configure the bridge.</li>
<li>Set the following permissions for the webhook :
<ul>
<li>Repository
<ul>
<li>Actions (read)</li>
<li>Contents (read)</li>
<li>Discussions (read &amp; write)</li>
<li>Issues (read &amp; write)</li>
<li>Metadata</li>
<li>Projects (read &amp; write)</li>
<li>Pull requests (read &amp; write)</li>
</ul>
</li>
<li>Organisation
<ul>
<li>Team Discussions (read &amp; write)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="on-the-installation"><a class="header" href="#on-the-installation">On the installation</a></h3>
<ul>
<li>Copy sample file from <code>config-sample/hookshot/github.yml</code> to
<code>extra-config/hookshot</code></li>
<li>Edit the file with the following values :
<ul>
<li><code>github_auth_id</code> : The AppID given in your github app page</li>
<li><code>github_key_file</code> : The key file received via the <code>Generate a private key</code> button under <code>Private keys</code> section of the github app page.</li>
<li><code>github_webhook_secret</code> : The webhook secret configured in the app.</li>
<li><code>github_oauth_client_id</code> : The OAuth ClientID of the github app page.</li>
<li><code>github_oauth_client_secret</code> : The OAuth Client Secret of the github
app page.</li>
<li><code>github_oauth_default_options</code> A mapping to enable special oauth
options.</li>
</ul>
</li>
<li>Restart the install script</li>
</ul>
<h3 id="in-elements-room"><a class="header" href="#in-elements-room">In Element's room</a></h3>
<ul>
<li>As an administrator of the room, invite the hookshot bot</li>
<li>Start a private conversation with the bot</li>
<li>Type <code>github login</code></li>
<li>Follow the link to connect the bot to the configured app</li>
<li>If you have setup Dimension, you can use the integration manager to add
a bridge to github</li>
</ul>
<h2 id="enabling-gitlab-integration"><a class="header" href="#enabling-gitlab-integration">Enabling GitLab integration</a></h2>
<h3 id="on-gitlab"><a class="header" href="#on-gitlab">On GitLab</a></h3>
<ul>
<li>Add a webhook under the group or the repository you are targeting</li>
<li>On the webhook URL, set the following one : <code>https://&lt;hookshot_fqdn&gt;/</code></li>
<li>For the webhook secret, you can generate one using <code>pwgen 32 1</code>
to generate one for example. Keep it somewhere safe, you'll need to to
configure the bridge.</li>
<li>You should add the events you wish to trigger on. Hookshot currently
supports:
<ul>
<li>Push events</li>
<li>Tag events</li>
<li>Issues events</li>
<li>Merge request events</li>
<li>Releases events</li>
</ul>
</li>
</ul>
<h3 id="on-the-installation-1"><a class="header" href="#on-the-installation-1">On the installation</a></h3>
<ul>
<li>Copy sample file from <code>config-sample/hookshot/gitlab.yml</code> to
<code>extra-config/hookshot</code></li>
<li>Edit the file with the following values :
<ul>
<li><code>gitlab_instances</code>: A mapping of the GitLab servers
<ul>
<li><code>git.example.org</code>: Replace with name of the GitLab server
<ul>
<li><code>url</code>: Replace with URL of the GitLab server</li>
</ul>
</li>
</ul>
</li>
<li><code>gitlab_webhook_secret</code>: The secret configured in the webhook.</li>
</ul>
</li>
</ul>
<h3 id="in-elements-room-1"><a class="header" href="#in-elements-room-1">In Element's room</a></h3>
<ul>
<li>As an administrator of the room, invite the hookshot bot</li>
<li>As an administrator of the room, run the command <code>/devtools</code></li>
<li>Choose <code>Send Custom Event</code></li>
<li>Switch the button <code>Event</code> to <code>State Event</code> by clicking on it</li>
<li>In <code>Event Type</code>, enter <code>uk.half-shot.matrix-hookshot.gitlab.repository</code></li>
<li>In <code>State key</code>, enter a random value, for example generated after <code>pwgen 32 1</code></li>
<li>In <code>Event Content</code>, enter :</li>
</ul>
<pre><code class="language-json">{
    &quot;instance&quot;: &quot;&lt;your instance name in gitlab.yml&gt;&quot;,
    &quot;path&quot;: &quot;&lt;username-or-group/repo&gt;&quot;
}
</code></pre>
<h2 id="enabling-jira-integration"><a class="header" href="#enabling-jira-integration">Enabling JIRA integration</a></h2>
<h3 id="on-jira"><a class="header" href="#on-jira">On JIRA</a></h3>
<ul>
<li>This should be done for all JIRA organisations you wish to bridge. The
steps may differ for SaaS and on-prem, but you need to go to the
webhooks configuration page under Settings &gt; System. It should point to
<code>https://&lt;hookshot_fqdn&gt;/</code></li>
<li>For the webhook secret, you can generate one using <code>pwgen 32 1</code>
to generate one for example. Keep it somewhere safe, you'll need to to
configure the bridge.</li>
</ul>
<h4 id="enable-oauth"><a class="header" href="#enable-oauth">Enable OAuth</a></h4>
<p>The JIRA service currently only supports atlassian.com (JIRA SaaS) when
handling user authentication. Support for on-prem deployments is hoping to
land soon.</p>
<ul>
<li>You'll first need to head to
<a href="https://developer.atlassian.com/console/myapps/create-3lo-app/">https://developer.atlassian.com/console/myapps/create-3lo-app/</a> to create a
&quot;OAuth 2.0 (3LO)&quot; integration.</li>
<li>Once named and created, you will need to:</li>
<li>Enable the User REST, JIRA Platform REST and User Identity APIs under
Permissions.</li>
<li>Use rotating tokens under Authorisation.</li>
<li>Set a callback url. This will be the public URL to hookshot with a path
of /jira/oauth.</li>
<li>Copy the client ID and Secret from Settings</li>
</ul>
<h3 id="on-the-installation-2"><a class="header" href="#on-the-installation-2">On the installation</a></h3>
<ul>
<li>Copy sample file from <code>config-sample/hookshot/jira.yml</code> to
<code>extra-config/hookshot</code></li>
<li>Edit the file with the following values :
<ul>
<li><code>jira_webhook_secret</code>: The webhook secret configured</li>
<li><code>jira_oauth_client_id</code>: If Oauth is enabled, it should point to the
ClientID in Jira's App page. Else, you can keep it empty.</li>
<li><code>jira_oauth_client_secret</code>: If Oauth is enabled, it should point to
the Client secret in Jira's App page. Else, you can keep it empty.</li>
</ul>
</li>
</ul>
<h3 id="in-elements-room-2"><a class="header" href="#in-elements-room-2">In Element's room</a></h3>
<ul>
<li>As an administrator of the room, invite the hookshot bot</li>
<li>If you have setup Dimension, you can use the integration manager to add
a bridge to JIRA</li>
</ul>
<h2 id="enabling-generic-webhooks-integration"><a class="header" href="#enabling-generic-webhooks-integration">Enabling generic webhooks integration</a></h2>
<h3 id="on-the-installation-3"><a class="header" href="#on-the-installation-3">On the installation</a></h3>
<ul>
<li>Copy sample file from <code>config-sample/hookshot/generic.yml</code> to
<code>extra-config/hookshot</code></li>
<li>Edit the file with the following values :
<ul>
<li><code>generic_enabled</code>: <code>true</code> to enable it</li>
<li><code>generic_allow_js_transformation_functions</code>:
<code>true</code> if you want to enable <a href="https://matrix-org.github.io/matrix-hookshot/setup/webhooks.html#javascript-transformations">javascript
transformations</a></li>
<li><code>generic_user_id_prefix</code>: Choose a prefix for the users generated by
hookshot for webhooks you'll create</li>
</ul>
</li>
</ul>
<h3 id="in-elements-room-3"><a class="header" href="#in-elements-room-3">In Element's room</a></h3>
<ul>
<li>As an administrator of the room, invite the hookshot bot</li>
<li>Type <code>!hookshot webhook &lt;name of the webhook&gt;</code></li>
<li>The bot will answer with a URL that you can set up as a webhook.</li>
<li>Please ensure that the <code>Content-Type</code> is set to the type matching what
the webhook sends</li>
<li>If you have setup Dimension, you can use the integration manager to add
a bridge to a new webhook</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="summary"><a class="header" href="#summary">Summary</a></h1>
<p><a href="./introduction.html">Introduction</a></p>
<ul>
<li><a href="./install-poc.html">How to Install a POC Environment</a></li>
<li><a href="./install-prod.html">How to Install a Production Environment</a></li>
<li><a href="./permalinks.html">Setting up Permalinks</a></li>
<li><a href="./jitsi.html">Setting up Jitsi</a></li>
<li><a href="./saml.html">Setting up SSO/SAML</a></li>
<li><a href="./groupsync.html">Setting up Group Sync</a></li>
<li><a href="./dimension.html">Setting Up the Integration Manager</a></li>
<li><a href="./hookshot.html">Setting up GitLab, GitHub, and JIRA Integrations</a></li>
</ul>
<p><a href="./SUMMARY.html">Last Updated: April 4, 2022 at 8:30pm London Time</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
