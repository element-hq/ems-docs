<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js element">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Element Enterprise Installer Documentation</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="src/book-assets/element-theme.css">
        <link rel="stylesheet" href="src/book-assets/font.css">
        <link rel="stylesheet" href="src/book-assets/logo.css">
        <link rel="stylesheet" href="src/book-assets/style.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "element";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('element')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="install-poc.html"><strong aria-hidden="true">1.</strong> How to Install a POC Environment</a></li><li class="chapter-item expanded "><a href="install-prod.html"><strong aria-hidden="true">2.</strong> How to Install a Production Environment</a></li><li class="chapter-item expanded "><a href="permalinks.html"><strong aria-hidden="true">3.</strong> Setting up Permalinks</a></li><li class="chapter-item expanded "><a href="saml.html"><strong aria-hidden="true">4.</strong> Setting up SSO/SAML</a></li><li class="chapter-item expanded "><a href="groupsync.html"><strong aria-hidden="true">5.</strong> Setting up Group Sync</a></li><li class="chapter-item expanded affix "><a href="SUMMARY.html">Last Updated: February 10, 2022 at 9:30pm London Time</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="element">Element (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        <img alt="Element logo" class="header-logo" src="">
                    </div>

                    <h1 class="menu-title">Element Enterprise Installer Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Welcome to the Element Enterprise Installer Documentation! Element Enterprise
Installer enables you to install Element Enterprise for two purposes:</p>
<ul>
<li>Proof of concept on a single node. For this, we use microk8s on Ubuntu.</li>
<li>Production on multiple nodes. For this, we will install into an existing
kubernetes environment.</li>
</ul>
<p>The Element Enterprise Installer supports the following features:</p>
<ul>
<li>Synapse Homeserver - A synapse homeserver configured to Element's best
practices will be installed.</li>
<li>Element Web - An instance of Element Web will be configured to Element's
best practices and immediately available post installation.</li>
<li>SSO / SAML - The installer is able to configure using your LDAP/AD based
infrastructure over SSO/SAML technologies for login.</li>
<li>Group Sync - The installer is able to configure group sync v1, which enables
the application of ACLs from your LDAP/AD architecture to Spaces and Rooms in
the Element ecosystem. Please note that the initial version we are providing
only supports a single node, non-federated configuration.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="element-enterprise-installer-how-to-install-a-poc-environment"><a class="header" href="#element-enterprise-installer-how-to-install-a-poc-environment">Element Enterprise Installer: How to Install a POC Environment</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Our Element Enterprise Installer can handle the installation of Element Proof
of Concept (POC) environments. Our standard POC environment is a single node
server with multik8s running that we deploy our Element Enterprise Operator
to, resulting in a fully functioning Synapse server with Element Web that
can be used to conduct a POC. On-premise production deployments use the
same installer and operator, but are intended to be deployed into a full
kubernetes environment.</p>
<p>To get started with a POC installation, there are several things that need
to be considered and this guide will work through them:</p>
<ul>
<li><a href="install-poc.html#hostnamesdns">Hostnames/DNS</a></li>
<li><a href="install-poc.html#machine-size">Machine Size</a></li>
<li><a href="install-poc.html#operating-system">Operating System</a> (We’ve tested on
Ubuntu Server 20.04)</li>
<li><a href="install-poc.html#network-ports-to-open">Network Ports to Open</a></li>
<li><a href="install-poc.html#postgresql-database">Postgresql Database</a></li>
<li><a href="install-poc.html#ssl-certificates">SSL Certificates</a></li>
<li><a href="install-poc.html#extra-configuration-items">Extra configuration items</a></li>
</ul>
<p>Once these areas have been covered, you’ll be able to install a POC
environment!</p>
<h2 id="hostnamesdns"><a class="header" href="#hostnamesdns">Hostnames/DNS</a></h2>
<p>You will need hostnames for the following pieces of infrastructure:</p>
<ul>
<li>Postgresql Server</li>
<li>Element Server</li>
<li>Synapse Server</li>
</ul>
<p>These hostnames must resolve to the appropriate IP addresses. If you have a
proper DNS server with records for these hostnames in place, then you will
be good to go.</p>
<p><code>/etc/hosts</code> may be used as an alternative to proper DNS in a POC scenario
only. In this case, you will need entries similar to:</p>
<pre><code class="language-plaintext">192.168.122.39 element.local element
192.168.122.39 synapse.local synapse
</code></pre>
<h2 id="machine-size"><a class="header" href="#machine-size">Machine Size</a></h2>
<p>For running a proof of concept with our installer, we support only the x86_64
architecture and recommend the following minimums:</p>
<ul>
<li>No federation: 4 vCPUs/CPUS and 16GB RAM</li>
<li>Federation: 8 vCPUs/CPUS and 32GB RAM</li>
</ul>
<h2 id="operating-system"><a class="header" href="#operating-system">Operating System</a></h2>
<p>To get started, we have tested on Ubuntu 20.04 and suggest that you start
there as well. For x86_64, you can grab the iso here:</p>
<p><a href="https://releases.ubuntu.com/20.04.3/ubuntu-20.04.3-live-server-amd64.iso">https://releases.ubuntu.com/20.04.3/ubuntu-20.04.3-live-server-amd64.iso</a></p>
<p>Make sure to select docker as a package option. Do set up ssh.</p>
<p>Once you log in, please run:</p>
<pre><code class="language-bash">sudo apt-get update
sudo apt-get upgrade
</code></pre>
<h3 id="further-pre-requisites"><a class="header" href="#further-pre-requisites">Further Pre-requisites</a></h3>
<p>You should have the installer unpacked in a directory on your server. We
will refer to this as the installer directory. Both the <code>parameters.yml</code>
and <code>secrets.yml</code> file live in this directory.</p>
<p>Please run the following commands to create the <code>/mnt/data</code> directory and
install the <code>python3-signedjson package</code> which will be used during the
configuration of the installer.</p>
<p>The <code>/mnt/data</code> directory should have at least 50 GB of space.</p>
<pre><code class="language-bash"># mkdir /mnt/data

# apt-get install python3-signedjson -y
</code></pre>
<h3 id="network-ports-to-open"><a class="header" href="#network-ports-to-open">Network Ports to Open</a></h3>
<p>Element Enterprise On-Premise needs to bind and serve content over:</p>
<ul>
<li>Port 80 TCP</li>
<li>Port 443 TCP</li>
</ul>
<p>In a default Ubuntu installation, these ports are allowed through the
firewall. You will need to ensure that these ports are passed through your
firewall.</p>
<h3 id="unpacking-the-installer"><a class="header" href="#unpacking-the-installer">Unpacking the Installer</a></h3>
<p>Please make sure that you unpack <code>element-enterprise-installer</code> onto your
POC system. The directory that it unpacks into will be referenced in this
document as the installer directory.</p>
<h2 id="postgresql-database"><a class="header" href="#postgresql-database">Postgresql Database</a></h2>
<p>The installation requires that you have a postgresql
database with a locale of C and UTF8 encoding set up. See
<a href="https://github.com/matrix-org/synapse/blob/develop/docs/postgres.md#set-up-database">https://github.com/matrix-org/synapse/blob/develop/docs/postgres.md#set-up-database</a>
for further details.</p>
<p>If you have this already, please make note of the database name, user,
and password as you will need these to begin the installation.</p>
<p>If you do not have a database that you can already connect to and you are
doing this for a POC only and not in production, you can create a quick
Postgresql database on the machine you’ll be doing the POC on. Element
does not ship Postgresql and you'll see these instructions rely on the Docker
Hub image for Postgresql.</p>
<p>To do this you can run:</p>
<pre><code class="language-bash">docker pull docker.io/postgres:latest
</code></pre>
<p>Install the <code>pwgen</code> utility:</p>
<pre><code class="language-bash">apt-get install pwgen -y
</code></pre>
<p>Generate a password to replace <code>insert_random_password_here</code> in the script
by doing:</p>
<pre><code class="language-bash">pwgen 32 1
</code></pre>
<p>Then create a script, <code>start_postgresql</code>:</p>
<pre><code class="language-bash">#!/bin/bash

docker run -d -p 5432:5432 -v $(pwd)/data:/var/lib/postgresql/data -e
POSTGRES_PASSWORD=&quot;insert_random_password_here&quot; -e POSTGRES_USER=&quot;element&quot;
-e POSTGRES_DB=&quot;element&quot; -e POSTGRES_INITDB_ARGS=&quot;--encoding UTF8 --locale C&quot; d
ocker.io/postgres:latest
</code></pre>
<p>Now create a directory for the postgresql database:</p>
<pre><code class="language-bash">mkdir data
</code></pre>
<p>Set the executable permission on <code>start_postgresql</code>:</p>
<pre><code class="language-bash">chmod +x start_postgresql
</code></pre>
<p>and finally start postgresql:</p>
<pre><code class="language-bash">./start_postgresql
</code></pre>
<h2 id="ssl-certificates"><a class="header" href="#ssl-certificates">SSL Certificates</a></h2>
<p>For SSL Certificates, you have three options:</p>
<ul>
<li>Signed certificates from an internet recognized authority.</li>
<li>LetsEncrypt</li>
<li>Self-signed certificates</li>
</ul>
<p>In the case of Signed certificates or LetsEncrypt, your hostnames must be
accessible on the internet.</p>
<p>In the case of self-signed certificates, these are acceptable for a PoC
environment, but will not be supported in a production environment as the
security risk would be too high. Configuring mobile clients and federation
will not be possible with self-signed certificates.</p>
<h3 id="certificates-without-letsencrypt"><a class="header" href="#certificates-without-letsencrypt">Certificates without letsencrypt</a></h3>
<p>If you have certificates for your Element fqdn and Synapse fqdn already,
then you can simply place the <code>.crt</code> and <code>.key</code> files in the certs directory
under the installer directory. Certificates in the certs directory must take
the form of <code>fqdn.cert</code> and <code>fqdn.key</code>.</p>
<h3 id="self-signed-certificates-with-mkcert"><a class="header" href="#self-signed-certificates-with-mkcert">Self-signed certificates with mkcert</a></h3>
<p>The following instructions will enable you to use a tool called mkcert to
generate self-signed certificates. Element nor Canonical ship this tool and
so these directions are provided as one example of how to get self-signed
certificates.</p>
<pre><code class="language-bash">apt-get install wget libnss3-tools
wget
https://github.com/FiloSottile/mkcert/releases/download/v1.4.3/mkcert-v1.4.3-linux-amd64
mv mkcert-v1.4.3-linux-amd64 /usr/bin/mkcert

chmod +x /usr/bin/mkcert
</code></pre>
<p>Once you have mkcert executable, you can run:</p>
<pre><code class="language-bash"># mkcert -install
The local CA is now installed in the system trust store! ⚡️
</code></pre>
<p>Now, you can verify the CA Root by doing:</p>
<pre><code class="language-bash"># mkcert -CAROOT
/root/.local/share/mkcert
</code></pre>
<p>Your output may not be exactly the same, but it should be similar. Once we’ve
done this, we need to generate self-signed certificates for our hostnames. In
our example, we’ll be using <code>element.local</code> and <code>synapse.local</code>, which
are both on the same host, <code>192.168.122.39</code>:</p>
<p>The run for the element fqdn looks like this:</p>
<pre><code class="language-bash"># mkcert element.local element 192.168.122.39 127.0.0.1

Created a new certificate valid for the following names
- &quot;element.local&quot;
- &quot;element&quot;
- &quot;192.168.122.39&quot;
- &quot;127.0.0.1&quot;

The certificate is at &quot;./element.local+3.pem&quot; and the key at
&quot;./element.local+3-key.pem&quot; ✅

It will expire on 1 May 2024
</code></pre>
<p>The run for the synapse fqdn looks like this:</p>
<pre><code class="language-bash"># mkcert synapse.local synapse 192.168.122.39 127.0.0.1

Created a new certificate valid for the following names
- &quot;synapse.local&quot;
- &quot;synapse&quot;
- &quot;192.168.122.39&quot;
- &quot;127.0.0.1&quot;

The certificate is at &quot;./synapse.local+3.pem&quot; and the key at
&quot;./synapse.local+3-key.pem&quot; ✅

It will expire on 1 May 2024
</code></pre>
<p>Once you have self-signed certificates, you need to copy them into the certs
directory under the installer directory. Certificates in the certs directory
must take the form of <code>fqdn.crt</code> and <code>fqdn.key</code>.</p>
<p>Using our above example, these are the commands we would need to run from
the installer directory: (We ran <code>mkcert</code> in that directory as well.)</p>
<pre><code class="language-bash">cp element.local+3.pem certs/element.local.crt
cp element.local+3-key.pem certs/element.local.key
cp synapse.local+3.pem certs/synapse.local.crt
cp synapse.local+3-key.pem certs/synapse.local.key
</code></pre>
<h3 id="certificates-with-letsencrypt"><a class="header" href="#certificates-with-letsencrypt">Certificates with LetsEncrypt</a></h3>
<p>Our installer also supports using LetsEncrypt to build certificates for your
host names and automatically install them into your environment. If your
hosts are internet accessible, this is the easiest method and only requires
an admin email address to provide to LetsEncrypt.</p>
<h2 id="parametersyml"><a class="header" href="#parametersyml">parameters.yml</a></h2>
<p>Now it is time to set <code>parameters.yml</code>. Using the example hostnames of
<code>element.local</code> and <code>synapse.local</code> (not resolvable on the internet), we
would set the following parameters first in <code>parameters.yml</code>:</p>
<pre><code class="language-bash">domain_name: local
element_fqdn: element.local
synapse_fqdn: synapse.local
</code></pre>
<p>Next, we need to set the variables related to Postgres:</p>
<pre><code class="language-bash">postgres_fqdn: element.local
postgres_user: element
postgres_db: element
postgres_ssl_mode: &quot;prefer&quot;
postgres_port: 5432
</code></pre>
<p>Now, we need to set information about the media host. By default, these are
set to <code>/mnt/data</code> for the path and a media size of 50Gi. If you need to
make changes you can, but the defaults are safe to leave in place as long
as you can fit 50Gi on <code>/mnt/data</code>.</p>
<pre><code class="language-bash">media_host_data_path: &quot;/mnt/data&quot;
media_size: &quot;50Gi&quot;
</code></pre>
<p>The next item in the configuration is the microk8s DNS resolvers. This
defaults to using Google’s DNS. You may change this if you need to use
your company’s DNS.</p>
<pre><code class="language-bash">microk8s_dns_resolvers: &quot;8.8.8.8,8.8.4.4&quot;
</code></pre>
<p>The next section pertains to certmanager. If you are using your own
certificates, please leave these items both blank, as such:</p>
<pre><code class="language-bash">certmanager_issuer:
certmanager_admin_email:
</code></pre>
<p>If you have chosen to use letsencrypt, please specify “letsencrypt” for
the certmanager_issue and an actual email address for who should manage the
certificates for certmanager_admin_email:</p>
<pre><code class="language-bash">certmanager_issuer: 'letsencrypt'
certmanager_admin_email: admin@mydomain.com'
</code></pre>
<h2 id="secretsyml"><a class="header" href="#secretsyml">secrets.yml</a></h2>
<p>Now we move on to configuring <code>secrets.yml</code>. You will need the following
items here:</p>
<ul>
<li>A Macaroon key</li>
<li>Your postgres password for the user specified in parameters.yml</li>
<li>A Registration Shared Secret</li>
<li>A signing Key</li>
<li>A Registry username and token, which will have been provided to you
by Element.</li>
</ul>
<p>For the <code>macaroon</code> key, the <code>registration_shared_secret</code> key, and the
<code>generic_shared_secret</code> key, you may
generate them with the <code>pwgen</code> utility. If you do not have this utility,
you may install it in Ubuntu with:</p>
<pre><code class="language-bash">apt-get install pwgen -y
</code></pre>
<p>Once you have the 'pwgen' tool, you can use it as follows:</p>
<pre><code class="language-bash">pwgen 32 1
</code></pre>
<p>At this point, you can set the following items in <code>secrets.yml</code>:</p>
<pre><code class="language-bash">macaroon: &quot;insert_pwgen_output_here&quot;
postgres_passwd: &quot;insert_random_password_here&quot;
registration_shared_secret: &quot;insert_different_pwgen_output_here&quot;
generic_shared_secret: &quot;insert_third_pwgen_output_here&quot;
</code></pre>
<p>In order to generate the signing key, we need to run:</p>
<pre><code class="language-bash">python3 tools/create_keys.py
</code></pre>
<p>This will create output similar to:</p>
<pre><code class="language-bash">Signing key: ed25519 0 8uCMyhmX5X3N78tkxGYzzjtZrKN0hGAw03ue4Pa/294
Verify key: ed25519 0 m9//8YDBgKCssHDp9AHpa5umUjn/B1HJXL0TngdUiFo
</code></pre>
<p>From this, we can specify in <code>secrets.yml</code>:</p>
<pre><code class="language-bash">signing_key: “ed25519 0 8uCMyhmX5X3N78tkxGYzzjtZrKN0hGAw03ue4Pa/294”
</code></pre>
<p>Do not forget to also set the values for <code>registry_username</code> and
<code>registry_token</code>, which will both be provided by Element.</p>
<h2 id="extra-configuration-items"><a class="header" href="#extra-configuration-items">Extra Configuration Items</a></h2>
<p>It is possible to configure anything in Synapse's
<a href="https://github.com/matrix-org/synapse/blob/develop/docs/sample_config.yaml">homeserver.yaml</a>
or Element’s
<a href="https://github.com/vector-im/element-web/blob/develop/docs/config.md">config.json</a>.</p>
<p>To do so, you need to create json or yaml files in an <code>extra-config</code>
directory under the installer directory. These files will be merged to the
target configuration file.</p>
<p>Samples are available in <code>config-sample</code> under the installer directory.</p>
<p>To configure synapse:</p>
<ul>
<li>Create a directory <code>extra-config/synapse</code> at the root of the installer
directory : <code>mkdir -p extra-config/synapse</code></li>
<li>Copy the configurations extensions you want to setup from
<code>config-sample/synapse</code> to <code>extra-config/synapse</code>.</li>
<li>Edit the values in the file accordingly to your configuration</li>
</ul>
<p>To configure element:</p>
<ul>
<li>Create a directory <code>extra-config/element</code> at the root of the installer
directory : <code>mkdir -p extra-config/element</code></li>
<li>Copy the configurations extensions you want to setup from
<code>config-sample/element</code> to <code>extra-config/element</code>.</li>
<li>Edit the values in the file accordingly to your configuration</li>
</ul>
<p>For specifics on configuring permalinks for Element, please see <a href="./permalinks.html">Configuring
Permalinks</a>.</p>
<p>For specifics on setting up SSO/SAML, please see <a href="./saml.html">Setting up
SSO/SAML</a>.</p>
<p>For specifics on setting up Group Sync, please see <a href="./groupsync.html">Setting up Group
Sync</a>.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>Let’s review! Have you considered:</p>
<ul>
<li><a href="install-poc.html#hostnamesdns">Hostnames/DNS</a></li>
<li><a href="install-poc.html#operating-system">Operating System</a> (We’ve tested on
Ubuntu Server 20.04)</li>
<li><a href="install-poc.html#postgresql-database">Postgresql Database</a></li>
<li><a href="install-poc.html#ssl-certificates">SSL Certificates</a></li>
<li><a href="install-poc.html#extra-configuration-items">Extra configuration items</a></li>
</ul>
<p>Once you have the above sections taken care of and your <code>parameters.yml</code>
and <code>secrets.yml</code> files are in order, you are ready to begin the actual
installation.</p>
<p>From the installer directory, run:</p>
<pre><code class="language-bash">bash install.sh
</code></pre>
<p>The first run should go for a little while and then exit, instructing you
to log out and back in.</p>
<p>Please log out and back in and re-run the installer from the installer
directory again:</p>
<pre><code class="language-bash">bash install.sh
</code></pre>
<p>Once this has finished, you can run:</p>
<pre><code class="language-bash">kubectl get pods -n element-onprem
</code></pre>
<p>And you should get similar output to:</p>
<pre><code class="language-bash">NAME                                       READY   STATUS    RESTARTS   AGE
app-element-web-5c8c6d8765-2hwvm           1/1     Running   0          52m
server-well-known-59f87956d8-f5j2h         1/1     Running   0          52m
instance-synapse-haproxy-f7c597bdb-tz28h   1/1     Running   0          52m
instance-synapse-main-0                    1/1     Running   0          52m
</code></pre>
<p>At this time, you should also be able to browse to: <code>https://fqdn</code> and create
a test account with Element on your new homeserver. Using our example values,
I am able to go to <code>https://element.local/</code> and register an account, sign
in and begin testing the proof of concept!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="element-enterprise-installer-how-to-install-a-production-environment"><a class="header" href="#element-enterprise-installer-how-to-install-a-production-environment">Element Enterprise Installer: How to Install a Production Environment</a></h1>
<p>Needs to be written.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-permalinks"><a class="header" href="#configuring-permalinks">Configuring Permalinks</a></h1>
<h2 id="on-element"><a class="header" href="#on-element">On Element</a></h2>
<ul>
<li>Copy sample file from <code>config-sample/element/permalinks.json</code> to
<code>extra-config/element</code></li>
<li>Edit the file :</li>
</ul>
<pre><code class="language-lang-none">{
    &quot;permalinkPrefix&quot;: &quot;https://&lt;element fqdn&gt;&quot;
}
</code></pre>
<ul>
<li>Restart the install script</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-saml"><a class="header" href="#configuring-saml">Configuring SAML</a></h1>
<h2 id="on-element-enterprise"><a class="header" href="#on-element-enterprise">On Element Enterprise</a></h2>
<ul>
<li>Depending on your provider, copy the sample file in the installer root
directory from <code>config-sample/synapse/</code> to <code>extra-config/synapse</code></li>
<li>Edit the file for the provider you are setting up. You have at least 3
parameters to edit :
<ul>
<li>The IdP metadata url</li>
<li>The name and description of your synapse server, which your provider
would display to inform the users to which app they are logging in</li>
</ul>
</li>
<li>Run the installer to configure SAML provisioning</li>
</ul>
<h2 id="on-the-provider"><a class="header" href="#on-the-provider">On the provider</a></h2>
<p><a href="./saml.html#azure-adfs">Azure ADFS</a></p>
<p><a href="./saml.html#keycloak">Keycloak</a></p>
<h3 id="azure-adfs"><a class="header" href="#azure-adfs">Azure ADFS</a></h3>
<ul>
<li>With an account with enough rights, go to : <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/StartboardApplicationsMenuBlade/AllApps/menuId/">Enterprise Applications
Portal</a></li>
<li>Click on  <code>New Application</code></li>
<li>Click on <code>Create your own application</code> on the top left corner</li>
<li>Choose a name for it, and select <code>Integrate any other application you don't find in the gallery</code></li>
<li>Click on &quot;Create&quot;</li>
<li>Select <code>Set up single sign on</code></li>
<li>Select <code>SAML</code></li>
<li><code>Edit</code> on <code>Basic SAML Configuration</code></li>
<li>In <code>Identifier</code>, add the following URL : <code>https://&lt;synapse fqdn&gt;/_synapse/client/saml2/metadata.xml</code></li>
<li>Remove the default URL</li>
<li>In <code>Reply URL</code>, add the following URL : <code>https://&lt;synapse fqdn&gt;/_synapse/client/saml2/authn_response</code></li>
<li>Click on <code>Save</code></li>
<li><code>Edit</code> on <code>Attributes &amp; Claims</code></li>
<li>Remove all defaults additional claims</li>
<li>Click on <code>Add new claim</code> to add the following claims. The UID will be used
as the MXID, the value here is mostly a suggestion :
<ul>
<li>Name: <code>uid</code>, Transformation : <code>ExtractMailPrefix</code>, Parameter 1 :
<code>user.userprincipalname</code></li>
<li>Name: <code>email</code>, Source attribute : <code>user.mail</code></li>
<li>Name: <code>displayName</code>, Source attribute : <code>user.displayname</code></li>
</ul>
</li>
<li>Click on <code>Save</code></li>
<li>In <code>Users and Groups</code>, add groups and users which may have access to element</li>
</ul>
<h3 id="keycloak"><a class="header" href="#keycloak">Keycloak</a></h3>
<ul>
<li>In <code>Configure</code> &gt; <code>Clients</code>, add a new client. Enter <code>https://&lt;synapse fqdn&gt;/_synapse/client/saml2/metadata.xml</code> as its Client ID</li>
<li>In <code>Mappers</code>, add the 3 following mappers :
<ul>
<li>Name: <code>uid</code> : User attribute : <code>username</code></li>
<li>Name: <code>email</code>, User attribute : <code>email</code></li>
<li>Name: <code>displayName</code>, Javascript mapper : <code>user.FirstName + &quot; &quot; + user.lastName</code></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-groupsync"><a class="header" href="#configuring-groupsync">Configuring Groupsync</a></h1>
<h2 id="on-element-enterprise-1"><a class="header" href="#on-element-enterprise-1">On Element Enterprise</a></h2>
<ul>
<li>
<p>In the installer root directory, Copy the sample file from
<code>config-sample/groupsync/gsync.yml</code> to <code>extra-config/groupsync</code></p>
</li>
<li>
<p>Edit the file with the following values. Note that Element
will provide you with the <code>ems_bridges_registry_token_name</code> and the
<code>ems_bridges_registry_token_password</code>.</p>
<ul>
<li><code>ems_bridges_registry_username</code>: ems_bridges_registry_token_name</li>
<li><code>ems_bridges_registry_password</code>: ems_bridges_registry_token_password</li>
<li><code>ldap_check_interval_seconds</code>: The interval check in seconds</li>
<li><code>ldap_uri</code>: The LDAP Uri to connect to the ldap server</li>
<li><code>ldap_base</code>: The LDAP base used to build the space hierarchy. This OU
will become the root space. Every OU below this base will be a child-space.</li>
<li><code>ldap_bind_dn</code>: The user bind dn to use to read the space hierarchy.</li>
<li><code>ldap_bind_password</code>: The user password</li>
<li><code>ldap_attrs_uid</code>: The attribute to use to map to users mxids</li>
<li><code>ldap_attrs_name</code>: The attribute to use to map to spaces names</li>
<li><code>group_power_levels</code> : A list of LDAP security groups that'll determine
people's Matrix power levels. This affects only the OU (Space) that the
Group belongs to – doesn't leak up or down.</li>
<li><code>provisioner.dn_default_prefix</code>: Display names starting with this prefix
will get corrected according to the names we found for their users in
LDAP. Optional. Useful if you're using an OIDC provider that doesn't give
you users' display names.</li>
<li><code>provisioner.default_rooms</code> : Optional. A list of rooms that'll get
automatically created in in managed space. The ID is required to enable
GPS to track whether they were already created or not. You can change it,
but it'll cause new rooms to be generated.</li>
<li><code>provisioner.whitelisted_users</code> : Optional. A list of userid patterns
that will not get kicked from rooms even if they don't belong to them
according to LDAP. This is useful for things like the auditbot. Patterns
listed here will be wrapped in ^ and $ before matching.</li>
</ul>
</li>
<li>
<p>Restart the install script</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="summary"><a class="header" href="#summary">Summary</a></h1>
<p><a href="./introduction.html">Introduction</a></p>
<ul>
<li><a href="./install-poc.html">How to Install a POC Environment</a></li>
<li><a href="./install-prod.html">How to Install a Production Environment</a></li>
<li><a href="./permalinks.html">Setting up Permalinks</a></li>
<li><a href="./saml.html">Setting up SSO/SAML</a></li>
<li><a href="./groupsync.html">Setting up Group Sync</a></li>
</ul>
<p><a href="./SUMMARY.html">Last Updated: February 10, 2022 at 9:30pm London Time</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
